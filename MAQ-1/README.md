# MAQ-1: Laborat√≥rio de Vulnerabilidades - Windows Server 2022

## Vis√£o Geral

Este laborat√≥rio simula um ambiente Windows Server 2022 para estudos de seguran√ßa e an√°lise de vulnerabilidades. Utiliza a imagem `dockur/windows` que executa Windows Server via QEMU/KVM dentro de um container Docker.

**‚ö†Ô∏è ATEN√á√ÉO: Este √© um ambiente de LABORAT√ìRIO com vulnerabilidades intencionais. NUNCA use em produ√ß√£o!**

## üéØ Objetivos do Laborat√≥rio

- Configurar Windows Server 2022 em ambiente containerizado
- Implementar simula√ß√µes de ataques via WinRM (Windows Remote Management)
- Demonstrar t√©cnicas de an√°lise de artefatos maliciosos
- Praticar resposta a incidentes em ambiente controlado
- Estudar comportamentos de malware em sistemas Windows

## üöÄ Instru√ß√µes de Execu√ß√£o

### 1. Preparar o Ambiente
```bash
# Clonar o reposit√≥rio (se necess√°rio)
git clone <repository-url>
cd lab-vuln/MAQ-1

# Verificar depend√™ncias
python3 --version
docker --version
```

### 2. Iniciar o Laborat√≥rio
```bash
# Iniciar o container Windows
./setup.sh

# IMPORTANTE: Na primeira execu√ß√£o, o Windows Server 2022 ser√° baixado e instalado
# Este processo pode demorar 30-60 minutos dependendo da sua conex√£o
# Monitore o progresso em: http://localhost:8006

# Para acompanhar a instala√ß√£o em tempo real:
./monitor-installation.sh

# Aguardar alguns minutos para o Windows inicializar completamente
# O processo pode demorar 5-10 minutos ap√≥s a instala√ß√£o
```

### 3. Configurar WinRM (OBRIGAT√ìRIO)

**‚ö†Ô∏è IMPORTANTE: O WinRM deve ser configurado manualmente DENTRO do Windows ap√≥s a primeira inicializa√ß√£o.**

```bash
# 1. Verificar se h√° instru√ß√µes de configura√ß√£o
./setup-winrm.sh

# 2. Acessar o Windows:
#    - Web: http://localhost:8006
#    - RDP: localhost:3389 (usu√°rio: Docker, senha: admin)

# 3. Dentro do Windows, abrir PowerShell como Administrador e executar:
#    PowerShell -ExecutionPolicy Bypass -File "\\host.lan\Data\configure-winrm.ps1"

# 4. Testar a conectividade:
./setup-winrm.sh test
```

**üîß O que o script `configure-winrm.ps1` faz:**
- Habilita o servi√ßo WinRM
- Configura autentica√ß√£o b√°sica
- Permite conex√µes n√£o criptografadas (apenas para laborat√≥rio)
- Configura regras de firewall
- Testa a configura√ß√£o automaticamente

### 4. Executar Simula√ß√µes de Ataquedows Server 2022

## Vis√£o Geral

Este laborat√≥rio simula um ambiente Windows Server 2022 para estudos de seguran√ßa e an√°lise de vulnerabilidades. Utiliza a imagem `dockur/windows` que executa Windows Server via QEMU/KVM dentro de um container Docker.

**‚ö†Ô∏è ATEN√á√ÉO: Este √© um ambiente de LABORAT√ìRIO com vulnerabilidades intencionais. NUNCA use em produ√ß√£o!**

## üéØ Objetivos do Laborat√≥rio

- Configurar Windows Server 2022 em ambiente containerizado
- Implementar simula√ß√µes de ataques via WinRM (Windows Remote Management)
- Demonstrar t√©cnicas de an√°lise de artefatos maliciosos
- Praticar resposta a incidentes em ambiente controlado
- Estudar comportamentos de malware em sistemas Windows

## üöÄ Instru√ß√µes de Execu√ß√£o

### 1. Preparar o Ambiente
```bash
# Clonar o reposit√≥rio (se necess√°rio)
git clone <repository-url>
cd lab-vuln/MAQ-1

# Verificar depend√™ncias
python3 --version
docker --version
```

### 2. Iniciar o Laborat√≥rio
```bash
# Iniciar o container Windows
./setup.sh

# IMPORTANTE: Na primeira execu√ß√£o, o Windows Server 2022 ser√° baixado e instalado
# Este processo pode demorar 30-60 minutos dependendo da sua conex√£o
# Monitore o progresso em: http://localhost:8006

# Para acompanhar a instala√ß√£o em tempo real:
./monitor-installation.sh

# Aguardar alguns minutos para o Windows inicializar completamente
# O processo pode demorar 5-10 minutos ap√≥s a instala√ß√£o
```

### 3. Executar Simula√ß√µes de Ataque
```bash
# Acessar menu interativo
./attack-test.sh

# OU acessar menu diretamente
./attack-test.sh artefatos
```

### 5. Acessar o Sistema Windows

- **Web Interface (noVNC)**: http://localhost:8006
- **RDP**: `localhost:3389`
  - Usu√°rio: `Docker`
  - Senha: `admin`

## üèóÔ∏è Arquitetura do Laborat√≥rio

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                    LABORAT√ìRIO MAQ-1                       ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ  Windows Server 2022 (via dockur/windows)                  ‚îÇ
‚îÇ  - QEMU/KVM dentro de container Docker                     ‚îÇ
‚îÇ  - WinRM na porta 5985 (requer configura√ß√£o manual)       ‚îÇ
‚îÇ  - Usu√°rio: Docker / Senha: admin                          ‚îÇ
‚îÇ  - Pol√≠ticas de execu√ß√£o PowerShell permissivas            ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ  Portas Expostas no Host:                                  ‚îÇ
‚îÇ  ‚Ä¢ 8006  - Web Viewer (noVNC)                              ‚îÇ
‚îÇ  ‚Ä¢ 3389  - RDP (Remote Desktop Protocol)                   ‚îÇ
‚îÇ  ‚Ä¢ 5985  - WinRM (Windows Remote Management)               ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ  Integra√ß√£o Host ‚Üî Windows:                               ‚îÇ
‚îÇ  ‚Ä¢ Scripts PowerShell executados via pywinrm              ‚îÇ
‚îÇ  ‚Ä¢ Comunica√ß√£o HTTP b√°sica (usu√°rio Docker:admin)         ‚îÇ
‚îÇ  ‚Ä¢ Execu√ß√£o de jobs em background para persist√™ncia       ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

## üî• Simula√ß√µes de Ataque Dispon√≠veis

### 1. Exfiltra√ß√£o Simulada (`exfiltracao_simulada_win.ps1`)
- **Objetivo**: Simular roubo de arquivos sens√≠veis
- **Comportamento**: 
  - Copia arquivo `hosts` do sistema para diret√≥rio tempor√°rio
  - Renomeia com timestamp para simular exfiltra√ß√£o
  - Gera log da atividade
- **Verifica√ß√£o**: Verificar arquivo em `C:\Users\Docker\AppData\Local\Temp\`

### 2. Flood de Logs (`flood_logs_win.ps1`)
- **Objetivo**: Gerar ru√≠do em logs de seguran√ßa
- **Comportamento**:
  - Cria 50 eventos falsos de tentativas de login
  - Simula ataques de for√ßa bruta com IPs fict√≠cios
  - Polui logs para dificultar an√°lise
- **Verifica√ß√£o**: Logs ficam vis√≠veis no Event Viewer do Windows

### 3. Persist√™ncia Simulada (`persistencia_simulada_win.ps1`)
- **Objetivo**: Simular backdoor persistente
- **Comportamento**:
  - Cria bind shell TCP na porta 4444
  - Executa como job em background
  - Mant√©m conex√£o dispon√≠vel para "atacante"
- **Verifica√ß√£o**: `telnet localhost 4444` (do host Linux)

### 4. Portscan Simulado (`portscan_simulado_win.ps1`)
- **Objetivo**: Simular reconnaissance de rede
- **Comportamento**:
  - Escaneia portas comuns em localhost e 127.0.0.1
  - Identifica servi√ßos ativos (RDP, SMB, etc.)
  - Gera logs de tentativas de conex√£o
- **Verifica√ß√£o**: Output mostra portas abertas/fechadas

### 5. Ransomware Simulado (`ransomware_simulado_win.ps1`)
- **Objetivo**: Simular ataque de ransomware
- **Comportamento**:
  - Cria arquivos falsos (documentos, configs, backups)
  - Gera chave de criptografia aleat√≥ria
  - Criptografa arquivos e adiciona extens√£o `.locked`
  - Cria logs de arquivos afetados
- **Verifica√ß√£o**: Arquivos `.locked` em `C:\Users\Docker\AppData\Local\Temp\VulnFiles\`

### 6. Restaura√ß√£o de Ransomware (`ransomware_restore_win.ps1`)
- **Objetivo**: Simular recupera√ß√£o de dados
- **Comportamento**:
  - L√™ chave de criptografia salva
  - Descriptografa arquivos `.locked`
  - Restaura nomes originais
  - Remove arquivos criptografados
- **Verifica√ß√£o**: Arquivos originais restaurados sem extens√£o `.locked`

## üõ†Ô∏è Depend√™ncias e Requisitos

### Sistema Host (Linux)
- **Docker**: 20.10+ e Docker Compose
- **Python 3**: 3.8+ com pip
- **Biblioteca pywinrm**: Instalada automaticamente pelo script
- **Conectividade**: Acesso √† internet para download da imagem
- **Recursos**: M√≠nimo 4GB RAM, 20GB espa√ßo em disco

### Imagem Docker
- **Base**: `dockur/windows:latest`
- **SO**: Windows Server 2022
- **Recursos**: 2 CPU cores, 3GB RAM configurados
- **Armazenamento**: Volume persistente para dados

## üìã Como Verificar Resultados dos Ataques

### Via RDP (Recomendado)
```bash
# Conectar via RDP: localhost:3389
# Usu√°rio: Docker / Senha: admin

# Navegar para verificar artefatos:
# C:\Users\Docker\AppData\Local\Temp\
# - exfiltrated_hosts_*.txt (exfiltra√ß√£o)
# - VulnFiles\ (ransomware)

# Event Viewer para logs:
# Windows Logs > Security
# Windows Logs > Application
```

### Via PowerShell Remoto
```bash
# O script attack-test.sh j√° mostra sa√≠das dos comandos
# Logs aparecem automaticamente durante execu√ß√£o
```

### Verificar Servi√ßos
```bash
# Testar bind shell (se persist√™ncia ativa)
telnet localhost 4444

# Verificar processo svcmon-win.exe (se executado)
# Via RDP: Task Manager > Processes
```

## üîß Solu√ß√£o de Problemas

### Primeira Instala√ß√£o (Muito Importante!)
```bash
# Na PRIMEIRA execu√ß√£o, o sistema ir√°:
# 1. Baixar Windows Server 2022 (~5GB)
# 2. Extrair e configurar a imagem
# 3. Criar disco virtual de 128GB
# 4. Instalar e configurar o Windows

# TEMPO ESTIMADO: 30-60 minutos (dependendo da conex√£o)

# Monitorar instala√ß√£o:
./monitor-installation.sh

# Acompanhar visualmente:
# http://localhost:8006
```

### Container n√£o inicia
```bash
# Verificar portas em uso
netstat -tlnp | grep -E "(8006|3389|5985)"

# Verificar logs do Docker
docker logs maq1-windows

# Reiniciar servi√ßo Docker
sudo systemctl restart docker
```

### WinRM n√£o conecta
```bash
# 1. Verificar se o container est√° rodando
docker ps | grep maq1-windows

# 2. Verificar se Windows inicializou completamente
docker logs maq1-windows | grep "Windows started"

# 3. Executar diagn√≥stico completo
./diagnose-winrm.sh

# 4. Se necess√°rio, configurar WinRM manualmente:
#    - Acesse http://localhost:8006
#    - Abra PowerShell como Administrador
#    - Execute: PowerShell -ExecutionPolicy Bypass -File "\\host.lan\Data\configure-winrm.ps1"

# 5. Testar conectividade ap√≥s configura√ß√£o
./setup-winrm.sh test
```

**‚ö†Ô∏è LEMBRE-SE: O WinRM DEVE ser configurado manualmente dentro do Windows na primeira execu√ß√£o!**

### Scripts PowerShell falham
```bash
# Verificar se Windows terminou de inicializar
# Tentar conectar via RDP primeiro
# Verificar pol√≠tica de execu√ß√£o no Windows:
# Set-ExecutionPolicy -ExecutionPolicy Unrestricted -Scope LocalMachine
```

### Performance lenta
```bash
# Aumentar recursos no docker-compose.yml:
# cpus: "4"
# mem_limit: 4g

# Verificar recursos dispon√≠veis no host
free -h
df -h
```

## ‚ö†Ô∏è Avisos Importantes de Seguran√ßa

- **üö® NUNCA** execute este laborat√≥rio em redes de produ√ß√£o
- **üö® NUNCA** use as credenciais (`Docker:admin`) em sistemas reais
- As simula√ß√µes podem **gerar alertas** em sistemas de monitoramento
- Arquivos maliciosos s√£o **simula√ß√µes** e n√£o causam danos reais
- O ambiente cont√©m **credenciais fracas propositalmente**
- Destinado **EXCLUSIVAMENTE** para fins educacionais e treinamento

## üßπ Limpeza e Manuten√ß√£o

### Parar o Laborat√≥rio
```bash
# Parar container preservando dados
./setup.sh stop

# Parar e remover completamente
./setup.sh clean
```

### Reset Completo
```bash
# Remover volumes e recriar
docker-compose down -v
docker system prune -f
./setup.sh
```

## üìù Estrutura do Projeto

```
MAQ-1/
‚îú‚îÄ‚îÄ attack-test.sh              # Script principal de ataques
‚îú‚îÄ‚îÄ setup.sh                   # Script de configura√ß√£o
‚îú‚îÄ‚îÄ README.md                  # Esta documenta√ß√£o
‚îú‚îÄ‚îÄ .gitignore                 # Exclus√µes do Git
‚îú‚îÄ‚îÄ artefatos/                 # Scripts PowerShell
‚îÇ   ‚îú‚îÄ‚îÄ exfiltracao_simulada_win.ps1
‚îÇ   ‚îú‚îÄ‚îÄ flood_logs_win.ps1
‚îÇ   ‚îú‚îÄ‚îÄ persistencia_simulada_win.ps1
‚îÇ   ‚îú‚îÄ‚îÄ portscan_simulado_win.ps1
‚îÇ   ‚îú‚îÄ‚îÄ ransomware_simulado_win.ps1
‚îÇ   ‚îú‚îÄ‚îÄ ransomware_restore_win.ps1
‚îÇ   ‚îú‚îÄ‚îÄ svcmon-win.exe         # Agente C2 simulado
‚îÇ   ‚îî‚îÄ‚îÄ webshell_simulado_win.aspx
‚îú‚îÄ‚îÄ logs/                      # Estrutura para logs
‚îú‚îÄ‚îÄ vulnerable_files/          # Arquivos vulner√°veis simulados
‚îî‚îÄ‚îÄ windows/                   # Configura√ß√µes Docker
    ‚îú‚îÄ‚îÄ compose.yml           # Docker Compose
    ‚îú‚îÄ‚îÄ Dockerfile           # Build personalizado
    ‚îî‚îÄ‚îÄ system.config        # Configura√ß√µes do sistema
```

## üéì Cen√°rios de Uso Educacional

### Para Analistas de Seguran√ßa
- An√°lise de artefatos de ransomware
- Identifica√ß√£o de t√©cnicas de persist√™ncia
- Investiga√ß√£o de exfiltra√ß√£o de dados
- An√°lise de logs de seguran√ßa

### Para Administradores de Sistema
- Resposta a incidentes de seguran√ßa
- Configura√ß√£o de monitoramento
- Hardening de sistemas Windows
- Pol√≠ticas de preven√ß√£o

### Para Estudantes de Ciberseguran√ßa
- Compreens√£o de ataques reais
- Pr√°tica de an√°lise forense
- Desenvolvimento de scripts de detec√ß√£o
- Estudo de comportamento de malware

## üìö Refer√™ncias T√©cnicas

- **dockur/windows**: https://github.com/dockur/windows
- **WinRM Protocol**: https://docs.microsoft.com/en-us/windows/win32/winrm/portal
- **PyWinRM Library**: https://pypi.org/project/pywinrm/
- **PowerShell Security**: https://docs.microsoft.com/en-us/powershell/scripting/security/

---

**‚ö†Ô∏è LEMBRE-SE: Este √© um ambiente de LABORAT√ìRIO com vulnerabilidades intencionais para fins educacionais. NUNCA use em produ√ß√£o! ‚ö†Ô∏è**
